# Cursor
#test
javascript:(function(){
const currentVersion="2025.08.18",CURRENCY_FIELDS=["spent","today_spent","cost_per_purchase_fb","cost_per_add_to_cart_fb","cost_per_complete_registration_fb","cost_per_view_content_fb","cost_per_search_fb","cost_per_initiate_checkout_fb","cost_per_lead_fb","cost_per_add_payment_info_fb","cost_per_link_click","cpc","cpm"],CURRENCY_OFFSETS={DZD:100,ARS:100,AUD:100,BHD:100,BDT:100,BOB:100,BGN:100,BRL:100,GBP:100,CAD:100,CLP:1,CNY:100,COP:1,CRC:1,HRK:100,CZK:100,DKK:100,EGP:100,EUR:100,GTQ:100,HNL:100,HKD:100,HUF:1,ISK:1,INR:100,IDR:1,ILS:100,JPY:1,JOD:100,KES:100,KRW:1,LVL:100,LTL:100,MOP:100,MYR:100,MXN:100,NZD:100,NIO:100,NGN:100,NOK:100,PKR:100,PYG:1,PEN:100,PHP:100,PLN:100,QAR:100,RON:100,RUB:100,SAR:100,RSD:100,SGD:100,SKK:100,ZAR:100,SEK:100,CHF:100,TWD:1,THB:100,TRY:100,AED:100,UAH:100,USD:100,UYU:100,VEF:100,VND:1,FBZ:100,VES:100};class FbApi{apiUrl="https://adsmanager-graph.facebook.com/v23.0/";async getRequest(e,t=null,r=null){return r=r??__accessToken,await (await fetch(`${this.apiUrl}${e}?${t=null!=t?`${t}&access_token=${r}`:`access_token=${r}`}`,{headers:{accept:"text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9","accept-language":"ca-ES,ca;q=0.9,en-US;q=0.8,en;q=0.7","cache-control":"max-age=0","sec-ch-ua":'"Not?A_Brand";v="8", "Chromium";v="108", "Google Chrome";v="108"',"sec-ch-ua-mobile":"?0","sec-ch-ua-platform":'"Windows"',"sec-fetch-dest":"empty","sec-fetch-mode":"cors","sec-fetch-site":"same-site"},referrerPolicy:"strict-origin-when-cross-origin",body:null,method:"GET",mode:"cors",credentials:"include",referrer:"https://business.facebook.com/",referrerPolicy:"origin-when-cross-origin"})).json()}async getAllPages(e,t,r=null){let o=[],s=await this.getRequest(e,t,r);o=o.concat(s.data);let n=2;for(;s.paging&&s.paging.next;)s=await this.getRequest(s.paging.next,"",r),o=o.concat(s.data),n++;return o}async postRequest(e,t,r=null){return r=r??__accessToken,t.access_token=r,await (await fetch(`${this.apiUrl}${e}`,{headers:{accept:"*/*","accept-language":"en-US,en;q=0.9","content-type":"application/x-www-form-urlencoded","sec-ch-ua":'"Google Chrome";v="107", "Chromium";v="107", "Not=A?Brand";v="24"',"sec-ch-ua-mobile":"?0","sec-ch-ua-platform":'"Windows"',"sec-fetch-dest":"empty","sec-fetch-mode":"cors","sec-fetch-site":"same-site"},referrer:"https://business.facebook.com/",referrerPolicy:"origin-when-cross-origin",body:new URLSearchParams(t).toString(),method:"POST",mode:"cors",credentials:"include"})).json()}}class FbRules{fb=new FbApi;async getAllRules(e){return await this.fb.getRequest(`act_${e}/adrules_library`,"fields=id,name,evaluation_spec,execution_spec,schedule_spec,status")}async clearRules(e){let t=await this.getAllRules(e),r=t.data.length;if(0!=r)for(let o of(console.log(`Deleting ${r} rules.`),t.data))console.log(`Deleting rule ${JSON.stringify(o)}...`),console.log(await this.delRule(o.id))}async addRule(e,t,r,o,s){try{const n=r.filters&&r.filters.some(e=>CURRENCY_FIELDS.includes(e.field));if(n){const n={...r,filters:r.filters.filter(e=>!CURRENCY_FIELDS.includes(e.field))},l=await this.fb.postRequest(`act_${e}/adrules_library`,{locale:"en_US",evaluation_spec:JSON.stringify(n),execution_spec:JSON.stringify(o),name:t,schedule_spec:JSON.stringify(s),status:"ENABLED"});if(l.error)return console.error("Error creating initial rule:",l.error),l;const i=await this.fb.postRequest(`${l.id}`,{locale:"en_US",evaluation_spec:JSON.stringify(r),execution_spec:JSON.stringify(o),name:t,schedule_spec:JSON.stringify(s),status:"ENABLED"});return i.error?(console.error("Error updating rule with cost conditions:",i.error),i):i}return await this.fb.postRequest(`act_${e}/adrules_library`,{locale:"en_US",evaluation_spec:JSON.stringify(r),execution_spec:JSON.stringify(o),name:t,schedule_spec:JSON.stringify(s),status:"ENABLED"})}catch(n){return console.error("Error in addRule:",n),{error:{message:n.message||"Unknown error in addRule"}}}}async delRule(e){return await this.fb.postRequest(`${e}?method=delete`,{method:"delete"})}async execRule(e){return await this.fb.postRequest(`${e}/execute?method=post`,{method:"post",locale:"en_US"})}}class FileSelector{constructor(e){this.fileProcessor=e}createDiv(){this.div=document.createElement("div"),this.div.style.position="fixed",this.div.style.top="50%",this.div.style.left="50%",this.div.style.transform="translate(-50%, -50%)",this.div.style.width="200px",this.div.style.height="120px",this.div.style.backgroundColor="yellow",this.div.style.zIndex="1000",this.div.style.display="flex",this.div.style.flexDirection="column",this.div.style.alignItems="center",this.div.style.justifyContent="center",this.div.style.padding="10px",this.div.style.boxSizing="border-box",this.div.style.borderRadius="10px";var e=document.createElement("div");e.innerHTML="Select file to import autorules",e.style.textAlign="center",e.style.fontWeight="bold";var t=document.createElement("button");t.innerHTML="X",t.style.position="absolute",t.style.top="5px",t.style.right="5px",t.style.border="none",t.style.background="none",t.style.cursor="pointer",t.onclick=()=>{document.body.removeChild(this.div)},this.div.appendChild(e),this.div.appendChild(t)}createFileInput(){this.fileInput=document.createElement("input"),this.fileInput.type="file",this.fileInput.accept=".json",this.fileInput.style.display="none"}createButton(){this.button=document.createElement("button"),this.button.textContent="Select File",this.button.onclick=()=>{this.fileInput.click()}}show(){return new Promise((e,t)=>{this.createDiv(),this.createFileInput(),this.createButton(),this.div.appendChild(this.button),this.div.appendChild(this.fileInput),document.body.appendChild(this.div),this.fileInput.onchange=async()=>{if(!this.fileInput.files||0===this.fileInput.files.length){document.body.removeChild(this.div),alert("Operation canceled"),t("File selection cancelled by user");return}try{let r=await this.fileProcessor(this.fileInput.files[0]);document.body.removeChild(this.div),e(r)}catch(o){document.body.removeChild(this.div),t(o)}}})}}class FileHelper{async readFileAsJsonAsync(e){try{let t=await this.readFileAsync(e);return JSON.parse(t)}catch(r){throw console.error("Error:",r),r}}readFileAsync(e){return new Promise((t,r)=>{let o=new FileReader;o.onload=()=>{t(o.result)},o.onerror=()=>{r("Error reading file")},o.readAsText(e)})}}function convertCurrencyInRule(e,t,r){if(console.log("Conversion rate: ",t),console.log("Account currency: ",r),1===t)return e;let o=JSON.parse(JSON.stringify(e)),s=CURRENCY_OFFSETS[r]||100,n=CURRENCY_OFFSETS.USD||100;return console.log("Account offset: ",s,"USD offset: ",n),o.evaluation_spec&&o.evaluation_spec.filters&&o.evaluation_spec.filters.forEach(e=>{if(e.value&&!isNaN(e.value)&&CURRENCY_FIELDS.includes(e.field)){let r=parseFloat(e.value),o=r/t*(n/s);console.log("Original value: ",r,"USD value: ",o),e.value=Math.round(o).toString()}}),o}function convertCurrencyFromUSD(e,t,r){if(1===t)return e;let o=JSON.parse(JSON.stringify(e)),s=CURRENCY_OFFSETS[r]||100,n=CURRENCY_OFFSETS.USD||100;return o.evaluation_spec&&o.evaluation_spec.filters&&o.evaluation_spec.filters.forEach(e=>{if(e.value&&!isNaN(e.value)&&CURRENCY_FIELDS.includes(e.field)){let r=parseFloat(e.value),o=r/n*t*s;console.log("USD value: ",r,"Account value: ",o),e.value=Math.round(o).toString()}}),o}async function exportAutorules(){let e=new FbApi,t=new FbRules,r=require("BusinessUnifiedNavigationContext").adAccountID,o=[];try{console.log("Getting account info...");let s=await e.getRequest(`act_${r}`,"fields=currency,account_currency_ratio_to_usd"),n=s.account_currency_ratio_to_usd||1,l=s.currency||"USD";console.log(`Account currency: ${l}, conversion rate to USD: ${n}`),console.log("Getting autorules...");let i=await t.getAllRules(r);if(!i.data||0===i.data.length){showErrorLog(["No autorules found for this account."]);return}let a=i.data.map(e=>{try{"string"==typeof e.evaluation_spec&&(e.evaluation_spec=JSON.parse(e.evaluation_spec)),"string"==typeof e.execution_spec&&(e.execution_spec=JSON.parse(e.execution_spec)),"string"==typeof e.schedule_spec&&(e.schedule_spec=JSON.parse(e.schedule_spec));let t={id:e.id,name:e.name,evaluation_spec:e.evaluation_spec,execution_spec:e.execution_spec,schedule_spec:e.schedule_spec,status:e.status};return convertCurrencyInRule(t,n,l)}catch(r){let s=`Error processing rule ${e.name||e.id}: ${r.message||r}`;return console.error(s),o.push(s),null}}).filter(e=>null!==e),c={rules:a,metadata:{exportDate:new Date().toISOString(),sourceAccountId:r,sourceCurrency:l,conversionRate:n}},u=new Blob([JSON.stringify(c,null,2)],{type:"application/json"}),d=URL.createObjectURL(u),p=document.createElement("a");p.href=d,p.download=`autorules_${r}_${new Date().toISOString().split("T")[0]}.json`,p.click(),URL.revokeObjectURL(d);let h=`Successfully exported ${a.length} autorules (converted to USD).`;o.length>0?(o.unshift(h),showErrorLog(o)):alert(h)}catch(g){let y=`Error exporting autorules: ${g.message||g}`;console.error(y),o.push(y),showErrorLog(o)}}async function importRulesToAccount(e,t,r,o=[]){let s=new FbRules,n=new FbApi,l=[],i=0;try{console.log(`Getting info for account ${e}...`);let a=await n.getRequest(`act_${e}`,"fields=currency,account_currency_ratio_to_usd,name"),c=a.account_currency_ratio_to_usd||1,u=a.currency||"USD",d=a.name||e;if(console.log(`Account ${d} (${e}) currency: ${u}, conversion rate to USD: ${c}`),r){console.log(`Checking for existing rules in account ${e}...`);let p=await s.getAllRules(e);if(p.data&&p.data.length>0){await s.clearRules(e);let h=`Cleared ${p.data.length} existing autorules from account ${d} (${e}).`;console.log(h),l.push(h),o&&o.push(h)}}console.log(`Importing ${t.length} autorules to account ${e}...`);let g=t.map(e=>convertCurrencyFromUSD(e,c,u));for(let y of g)try{if(!y.name||!y.evaluation_spec||!y.execution_spec||!y.schedule_spec){let $=`Skipping rule ${y.name||"unknown"} for account ${d} (${e}): Missing required fields`;console.error($),l.push($),o&&o.push($);continue}delete y.id;let f=y.name,m=y.evaluation_spec,v=y.execution_spec,w=y.schedule_spec;y.status;let b=await s.addRule(e,f,m,v,w);if(b.error){let x=`Error adding rule ${f} to account ${d} (${e}): ${b.error.message||JSON.stringify(b.error)}`;console.error(x),l.push(x),o&&o.push(x);continue}i++}catch(C){let A=`Error importing rule ${rule.name||"unknown"} to account ${d} (${e}): ${C.message||C}`;console.error(A),l.push(A),o&&o.push(A)}let _=`Successfully imported ${i} out of ${t.length} autorules to account ${d} (${e}).`;return console.log(_),l.unshift(_),o&&o.push(_),{success:!0,importedCount:i,totalRules:t.length,errorLog:l}}catch(E){let S=`Error processing account ${e}: ${E.message||E}`;return console.error(S),l.push(S),o&&o.push(S),{success:!1,importedCount:i,totalRules:t.length,errorLog:l}}}async function importAutorulesToCurrentAccount(){let e=new FileHelper,t=require("BusinessUnifiedNavigationContext").adAccountID,r=[];try{let o=await new FileSelector(t=>e.readFileAsJsonAsync(t)).show();if(!o)return;if(!o.rules||!Array.isArray(o.rules)){showErrorLog(["Invalid file format. Expected a JSON file with 'rules' array."]);return}let s=document.getElementById("ywbClearExistingRules").checked;console.log("Clear existing rules: ",s),await importRulesToAccount(t,o.rules,s,r),showErrorLog(r)}catch(n){let l=`Error importing autorules: ${n.message||n}`;console.error(l),r.push(l),showErrorLog(r)}}async function importAutorulesToAllAccounts(){let e=new FileHelper,t=[];try{let r=await getAllAdAccounts();if(!r||0===r.length){showErrorLog(["No ad accounts found or accessible."]);return}let o=await new FileSelector(t=>e.readFileAsJsonAsync(t)).show();if(!o)return;if(!o.rules||!Array.isArray(o.rules)){showErrorLog(["Invalid file format. Expected a JSON file with 'rules' array."]);return}let s=document.getElementById("ywbClearExistingRules").checked;console.log("Clear existing rules: ",s),console.log(`Processing ${r.length} accounts...`);let n=0,l=0;for(let i=0;i<r.length;i++){let a=r[i];console.log(`Processing account ${a} (${i+1}/${r.length})...`);(await importRulesToAccount(a,o.rules,s,t)).success?n++:l++}let c=`Processed ${r.length} accounts: ${n} successful, ${l} failed.`;t.unshift(c),showErrorLog(t)}catch(u){let d=`Error importing autorules to all accounts: ${u.message||u}`;console.error(d),t.push(d),showErrorLog(t)}}async function getAllAdAccounts(){let e=new FbApi,t=[];return console.log("Getting personal ad accounts..."),t=(await e.getAllPages("me/adaccounts","fields=id")).map(e=>e.id.replace("act_","")),console.log(`Got ${t.length} ad accounts.`),t}class AutorulesManagerUI{constructor(){this.div=null,this.buttons={}}createDiv(){this.div=document.createElement("div"),this.div.style.position="fixed",this.div.style.top="50%",this.div.style.left="50%",this.div.style.transform="translate(-50%, -50%)",this.div.style.width="300px",this.div.style.backgroundColor="yellow",this.div.style.zIndex="1000",this.div.style.display="flex",this.div.style.flexDirection="column",this.div.style.alignItems="center",this.div.style.justifyContent="center",this.div.style.padding="20px",this.div.style.boxSizing="border-box",this.div.style.borderRadius="10px",this.div.style.boxShadow="0 4px 8px rgba(0, 0, 0, 0.2)";let e=document.createElement("div");e.innerHTML="<h2>FB Autorules Manager "+currentVersion+"</h2><p><a href='https://yellowweb.top' target='_blank'>by Yellow Web</a></p>",e.style.textAlign="center",e.style.marginBottom="20px";let t=document.createElement("button");return t.innerHTML="X",t.style.position="absolute",t.style.top="10px",t.style.right="10px",t.style.border="none",t.style.background="none",t.style.fontSize="18px",t.style.cursor="pointer",t.onclick=()=>{document.body.removeChild(this.div)},this.div.appendChild(e),this.div.appendChild(t),this.div}createButton(e,t,r){let o=document.createElement("button");return o.id=e,o.textContent=t,o.style.margin="10px 0",o.style.padding="10px 15px",o.style.width="100%",o.style.backgroundColor="#4CAF50",o.style.color="white",o.style.border="none",o.style.borderRadius="5px",o.style.cursor="pointer",o.style.fontSize="16px",o.setAttribute("data-original-text",t),this.buttons[e]=o,o.onclick=async()=>{this.setButtonLoading(e,!0);try{await r()}finally{this.setButtonLoading(e,!1)}},o}setButtonLoading(e,t){let r=this.buttons[e];r&&(t?(r.disabled=!0,r.style.opacity="0.7",r.style.cursor="not-allowed",r.textContent="Working on it..."):(r.disabled=!1,r.style.opacity="1",r.style.cursor="pointer",r.textContent=r.getAttribute("data-original-text")))}show(){let e=this.createDiv(),t=this.createButton("export-btn","Export Autorules to JSON",async()=>{await exportAutorules()}),r=document.createElement("div");r.style.display="flex",r.style.alignItems="center",r.style.margin="10px 0",r.style.width="100%";let o=document.createElement("input");o.type="checkbox",o.id="ywbClearExistingRules",o.style.marginRight="10px";let s=document.createElement("label");s.htmlFor="ywbClearExistingRules",s.textContent="Delete existing rules before import",s.style.fontSize="14px",r.appendChild(o),r.appendChild(s);let n=this.createButton("import-current-btn","Import Autorules to Current Account",async()=>{await importAutorulesToCurrentAccount()}),l=this.createButton("import-all-btn","Import Autorules to All Accounts",async()=>{await importAutorulesToAllAccounts()}),i=this.createButton("delete-current-btn","Delete Current Autorules",async()=>{let e=require("BusinessUnifiedNavigationContext").adAccountID,t=new FbRules;try{await t.clearRules(e),alert("All autorules have been deleted from the current account.")}catch(r){console.error("Error deleting rules:",r),showErrorLog([`Error deleting rules: ${r.message||r}`])}}),a=document.createElement("a");a.href="#",a.textContent="Copy as bookmark",a.style.fontSize="12px",a.style.color="blue",a.style.textDecoration="underline",a.style.cursor="pointer",a.style.marginTop="15px",a.style.display="block",a.style.textAlign="center",a.onclick=e=>{e.preventDefault(),copyScriptAsBase64Bookmarklet()},e.appendChild(t),e.appendChild(r),e.appendChild(n),e.appendChild(l),e.appendChild(i),e.appendChild(a),document.body.appendChild(e)}}function showAutorulesManager(){(new AutorulesManagerUI).show()}function showErrorLog(e){if(!e||0===e.length)return;let t=document.createElement("div");t.style.position="fixed",t.style.top="50%",t.style.left="50%",t.style.transform="translate(-50%, -50%)",t.style.width="500px",t.style.maxHeight="80vh",t.style.overflowY="auto",t.style.backgroundColor="#fff",t.style.border="1px solid #ccc",t.style.borderRadius="5px",t.style.padding="20px",t.style.boxShadow="0 4px 8px rgba(0, 0, 0, 0.2)",t.style.zIndex="2000";let r=document.createElement("h3");r.textContent="Operation Log",r.style.marginTop="0",t.appendChild(r);let o=document.createElement("button");o.textContent="Close",o.style.position="absolute",o.style.top="10px",o.style.right="10px",o.style.padding="5px 10px",o.style.cursor="pointer",o.onclick=()=>document.body.removeChild(t),t.appendChild(o);let s=document.createElement("ul");s.style.paddingLeft="20px",s.style.marginBottom="0",e.forEach(e=>{let t=document.createElement("li");t.textContent=e,e.toLowerCase().includes("error")?t.style.color="red":e.toLowerCase().includes("success")&&(t.style.color="green"),s.appendChild(t)}),t.appendChild(s),document.body.appendChild(t)}function copyScriptAsBase64Bookmarklet(){try{window.location.href;let e,t=`javascript:eval("(async () => {" + atob("${btoa(`// Constants
const currentVersion = "${currentVersion}";
const CURRENCY_FIELDS = ${JSON.stringify(CURRENCY_FIELDS)};
const CURRENCY_OFFSETS = ${JSON.stringify(CURRENCY_OFFSETS)};

${FbApi.toString()}

${FbRules.toString()}

${FileSelector.toString()}

${FileHelper.toString()}

${convertCurrencyInRule.toString()}

${convertCurrencyFromUSD.toString()}

${exportAutorules.toString()}

${importRulesToAccount.toString()}

${importAutorulesToCurrentAccount.toString()}

${importAutorulesToAllAccounts.toString()}

${getAllAdAccounts.toString()}

${AutorulesManagerUI.toString()}

${showAutorulesManager.toString()}

${showErrorLog.toString()}

${copyScriptAsBase64Bookmarklet.toString()}

// Make the functions available globally
window.showAutorulesManager = showAutorulesManager;
window.showErrorLog = showErrorLog;
window.copyScriptAsBase64Bookmarklet = copyScriptAsBase64Bookmarklet;

// Auto-run when script is loaded
showAutorulesManager();`)}") + "})();");`;navigator.clipboard.writeText(t).then(()=>{alert("Bookmarklet copied to clipboard!")}).catch(e=>{console.error("Failed to copy: ",e);let r=document.createElement("textarea");r.value=t,document.body.appendChild(r),r.select(),document.execCommand("copy"),document.body.removeChild(r),alert("Bookmarklet copied to clipboard!")})}catch(r){console.error("Error creating bookmarklet:",r),alert(`Error creating bookmarklet: ${r.message}`)}}window.showAutorulesManager=showAutorulesManager,window.showErrorLog=showErrorLog,window.copyScriptAsBase64Bookmarklet=copyScriptAsBase64Bookmarklet,showAutorulesManager();
  showAutorulesManager();
})();